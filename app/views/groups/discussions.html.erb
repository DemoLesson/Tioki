<section id="main-content" class="inner-content">
	<%= render 'heading' %>
	<section class="profile-content panel" style="margin:30px 0px;">
		<% unless User.current.nil? %>
			<section style="margin:15px 0px 0px 15px">
				<% if @in_group || @group.permissions['public_discussions'] %>
					<h4>
					Start a Discussion
					</h4>
					<form id="post-comment" action="<%= "/groups/#{@group.id}/comment" %>" method="post">
						<textarea name="comment" style="height:50px;width:84%;padding:10px 3%;" placeholder="Start a Discussion or Share Something with the Group"></textarea>
						<input type="submit" value="Post" style="margin:20px 20px 0px 0px;float:right" />
					</form>
				<% elsif !@group.permissions['public_discussions'] %>
					<h4>You must be a member of <%= @group.name %> to participate in discussions</h4>
				<% else %>
					<h4>
					<%= link_to "Join Group", { :action => "add_group", :id => @group.id}, :style => "color:#F66C4C" %> to start a discussion.
					</h4>
				<% end %>
			</section>
			<% if @in_group || @group.permissions['public_discussions'] %>
				<div class="comments inline">
				<h4 style="margin:-10px 0px 0px 15px">Top Comments</h4>
				<ul>
					<% @comments.each do |comment| %>
						<% @comment = comment %>
						<%= render 'comments/show' %></br>
					<% end %>
				</ul>

				<!-- Load js for processing comments - AJAX HACK -->
				<script type="text/javascript">
				$(document).ready(function() {
					$('form#post-comment').submit(function(e) {
						e.preventDefault();

						var form = $(this);
						$.post(form.attr('action') + '.json', form.serialize(), function(r) {
							if(r.id !== undefined && r.type == 'success') {
								form.find('textarea').val('Posted!').prop('disabled', true);
								$.get('/comments/' + r.id, function(d) {
									comment = $(d).css({'display': 'none', 'background-color': '#F66C4C'});
									$('div.comments ul').append(comment);
									comment.slideDown(500, function() {
										$('div.comments ul').scrollTo('100%', 800);
										setTimeout(function() {
											comment.animate({backgroundColor: '#FFF'}, 600);
											form.find('textarea').val('').prop('disabled', false);
										}, 1000);
									});
								});
							}
						})

						return false;
					});

					// Favorite a comment
					$('a[comment-action="favorite"]').live('click', function(e) {
						e.preventDefault();

						var link = $(this);
						$.get(link.attr('href') + '.json', function(r) {

							// Star the post
							if(r.type == 'success' && r.new) {
								link.removeClass('gray').addClass('salmon');
								var inc = parseInt(link.children('span').text()) + 1;
								if(isNaN(inc)) link.children('span').text('1');
								else link.children('span').text(inc);
							}

							// Unstar the post
							if(r.type == 'success' && !r.new) {
								link.removeClass('salmon').addClass('gray');
								var dec = parseInt(link.children('span').text()) - 1;
								if(isNaN(dec) || dec === 0) link.children('span').text('');
								else link.children('span').text(dec);
							}
						});

						return false;
					});

					// Delete a comment
					$('a[comment-action="delete"]').live('click', function(e) {
						e.preventDefault();

						var link = $(this);
						$.get(link.attr('href') + '.json', function(r) {
							var li = link.closest('li');

							// Hide the post
							if(r.type == 'success') li.slideUp(500, function() {
								$('span.tooltip').remove();
								$(this).remove();
							});
						});

						return false;
					});
				});
				</script>
				</div>
			<% end %>
		<% else %>
			<section style="margin:15px 0px 15px 15px;">
				<h3><%= link_to "Join Tioki", '/welcome_wizard?x=step1&group_join_link', :target => "_blank", :style => "color:#F66C4C" %> to Participate in this group's Discussions.
				</h3>
			</section>
		<% end %>
	</section>
</section>

<script type="text/javascript">
$(document).ready(function() {
	$('a[href="#facebook"]').click(function(e) {

		// Block the link
		e.preventDefault();

		// Trigger the facebook method
		FB.ui({
			method: 'feed',
			name: '<%=j @group.name %>',
			link: '<%= url_for(:only_path => false) %>',
			picture: 'http://www.tioki.com/assets/images/tioki/tioki-logo.png',
			caption: 'Come join this Group on Tioki.',
			description: 'Come join the "<%=j @group.name %>" group on Tioki; a professional development site for educators!'
		}
		/*function(response) {
			if (response && response.post_id) {
				alert('Post was published.');
			} else {
				alert('Post was not published.');
			}
		}*/);

		return false;
	});
	$('a[href="#twitter"]').click(function(e) {

		// URL to go to
		url = 'https://twitter.com/share';

		// Paramaters to build
		var params = {
			via: 'tioki',
			url: '<%= url_for(:only_path => false) %>',
			text: 'Come join the "<%=j @group.name %>" Group on Tioki!'
		}

		// URL plus params
		url += '?' + $.param(params);
		
		// Apply to the link
		$(this).attr('href', url).attr('target', '_blank');

		// GO!
		return true;
	});
});
</script>

<% unless User.current.nil? %>
<div id="share_on_tioki" class="kmodal">
	<h2>
		Share with other Tioki users.
	</h2>
	<p>
		Please select some of your connections to share with.
	</p>
	<section style="max-height:300px;overflow-y:scroll;">
		<form method="post" action="/groups/<%= @group.id %>/invite">
			<% Connection.mine(:pending => false).each do |connection| %>
			<% user = connection.not_me %>
			<div class="user" style="width:220px;height:80px;overflow:hidden;float:left;padding:10px;margin:5px;border:solid 1px #DADADA;box-sizing: border-box;-moz-box-sizing: border-box;-webkit-box-sizing: border-box;">
				<input style="float:right;width:15px;height:15px;" type="checkbox" name="connection[]" value="<%= user.id %>"></input>
				<div class="profile-thumb-small" style="float:left;">
					<%= link_to image_tag(user.avatar.url(:medium)), "/profile/#{user.slug}" if user.avatar? %>
					<%= link_to image_tag("/assets/dl_icons/no_avatar_tiny.jpg"), "/profile/#{user.slug}" unless user.avatar? %>
				</div>
				<p style="margin-top:0px;"><strong><%= user.profile_link %></strong><br /><%= user.location %>
			</div>
			<% end %>
			<div style="clear:both;"></div>
			<a style="float:right;margin:25px 5px 5px;font-size:20px;" href="javascript:void(0);" onclick="$(this).closest('form').submit();" class="button">Invite Connections</a>
		</form>
	</section>
</div>
<script type="text/javascript">
$(document).ready(function() {
	$('div.user').click(function(e) {
		e.preventDefault();

		var check = $(this).children('input');
		if(check.prop('checked')) {
			$(this).css('border-color', '#DADADA');
			check.prop('checked', false);
		}
		else {
			$(this).css('border-color', '#F66C4C');
			check.prop('checked', true);
		}

		return false;
	})
});
</script>
<% end %>
